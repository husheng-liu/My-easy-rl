### 问题背景

我们的目标是找到 $f(x, y) = (x - 3)^2 + (y - 2)^2$ 的最小值，已知其最优解为 $(x, y) = (3, 2)$，且最小值为 $f(3, 2) = 0$。

我们将使用 CMA-ES 来解决这个问题，并通过每一步的具体操作展示算法的工作原理。

---

### 1. 初始化

#### 输入：
- 初始解向量：$x_0 = [0, 0]$（初始猜测）。
- 步长：$\sigma = 1$（初始搜索范围）。
- 种群规模：$λ = 4$（每一代生成 4 个候选解）。
- 协方差矩阵：$C = I$（初始为单位矩阵，表示对称的球形分布）。
- 进化路径：$p_c = [0, 0]$，$p_\sigma = 0$。

---

### 2. 采样候选解

从当前搜索分布中采样生成一组候选解。假设当前均值为 $m_t = x_t = [0, 0]$，协方差矩阵为 $C = I$，步长为 $\sigma = 1$。

采样公式：
$$
x_{t,i} = m_t + \sigma \cdot N(0, C)
$$

假设采样得到以下 4 个候选解：
$$
x_{t,1} = [0.5, 0.8], \quad x_{t,2} = [-0.3, 1.2], \quad x_{t,3} = [1.1, -0.6], \quad x_{t,4} = [-0.8, -1.0]
$$

---

### 3. 评估候选解

计算每个候选解的目标函数值 $f(x, y)$：

$$
f(x_{t,1}) = (0.5 - 3)^2 + (0.8 - 2)^2 = 7.49
$$
$$
f(x_{t,2}) = (-0.3 - 3)^2 + (1.2 - 2)^2 = 11.45
$$
$$
f(x_{t,3}) = (1.1 - 3)^2 + (-0.6 - 2)^2 = 10.05
$$
$$
f(x_{t,4}) = (-0.8 - 3)^2 + (-1.0 - 2)^2 = 19.44
$$

按目标函数值从小到大排序：
$$
x_{t,(1)} = [0.5, 0.8], \quad x_{t,(2)} = [1.1, -0.6], \quad x_{t,(3)} = [-0.3, 1.2], \quad x_{t,(4)} = [-0.8, -1.0]
$$

---

### 4. 更新分布均值

更新搜索分布的均值：
$$
m_{t+1} = m_t + c_m \sum_{i=1}^μ w_i (x_{t,(i)} - m_t)
$$

假设 $c_m = 1$，权重 $w_1 = 0.5$ 和 $w_2 = 0.5$（只用前两个最优解），则：
$$
m_{t+1} = [0, 0] + 1 \cdot \left(0.5 \cdot ([0.5, 0.8] - [0, 0]) + 0.5 \cdot ([1.1, -0.6] - [0, 0])\right)
$$
$$
m_{t+1} = [0, 0] + 1 \cdot \left([0.25, 0.4] + [0.55, -0.3]\right)
$$
$$
m_{t+1} = [0.8, 0.1]
$$

新的分布均值为 $m_{t+1} = [0.8, 0.1]$。

---

### 5. 更新进化路径

#### 更新 $p_c$：
假设 $c_c = 0.1$，$hσ = 1$，$μ_eff = 2$，则：
$$
p_c = (1-c_c)p_c + hσ \sqrt{c_c(2-c_c)μ_eff} \sum_{i=1}^μ w_i (x_{t,(i)} - m_t)
$$
$$
p_c = (1-0.1)[0, 0] + 1 \cdot \sqrt{0.1(2-0.1)2} \cdot \left(0.5 \cdot ([0.5, 0.8] - [0, 0]) + 0.5 \cdot ([1.1, -0.6] - [0, 0])\right)
$$
$$
p_c = [0, 0] + 0.632 \cdot ([0.25, 0.4] + [0.55, -0.3])
$$
$$
p_c = [0.506, 0.063]
$$

#### 更新 $p_\sigma$：
类似地，假设 $c_σ = 0.1$，则：
$$
p_σ = (1-c_σ)p_σ + \sqrt{c_σ(2-c_σ)μ_eff} \frac{1}{σ} \sum_{i=1}^μ w_i (x_{t,(i)} - m_t)
$$
$$
p_σ = (1-0.1) \cdot 0 + \sqrt{0.1(2-0.1)2} \cdot \frac{1}{1} \cdot \left(0.5 \cdot ([0.5, 0.8] - [0, 0]) + 0.5 \cdot ([1.1, -0.6] - [0, 0])\right)
$$
$$
p_σ = 0.632 \cdot ([0.25, 0.4] + [0.55, -0.3])
$$
$$
p_σ = [0.506, 0.063]
$$

---

### 6. 更新协方差矩阵

更新协方差矩阵 $C$：
$$
C = (1-c_1-c_μ)C + c_1 p_c p_c^T + c_μ \sum_{i=1}^μ w_i (x_{t,(i)} - m_t)(x_{t,(i)} - m_t)^T
$$

假设 $c_1 = 0.1$，$c_μ = 0.1$，则：
$$
C = (1-0.1-0.1)I + 0.1 \cdot [0.506, 0.063][0.506, 0.063]^T + 0.1 \cdot \left(0.5 \cdot ([0.5, 0.8] - [0, 0])([0.5, 0.8] - [0, 0])^T + 0.5 \cdot ([1.1, -0.6] - [0, 0])([1.1, -0.6] - [0, 0])^T\right)
$$

经过计算后，得到新的协方差矩阵 $C$。

---

### 7. 更新步长

更新步长 $\sigma$：
$$
σ = σ \exp\left(\frac{||p_σ|| - E[||N(0,I)||]}{d_σ}\right)
$$

假设 $E[||N(0,I)||] = 1$，$d_σ = 0.1$，则：
$$
σ = 1 \cdot \exp\left(\frac{\sqrt{0.506^2 + 0.063^2} - 1}{0.1}\right)
$$
$$
σ = 1 \cdot \exp\left(\frac{0.51 - 1}{0.1}\right)
$$
$$
σ = 1 \cdot \exp(-4.9) \approx 0.007
$$

新的步长为 $\sigma = 0.007$。

---

### 8. 检查终止条件

检查是否满足终止条件：
- 是否达到最大迭代次数？
- 是否目标函数值足够小？

如果未满足，则返回步骤 2 继续下一次迭代。

---

### 9. 返回结果

最终输出的是优化过程中找到的最佳解和对应的函数值。例如，经过多次迭代后，CMA-ES 可能收敛到接近最优解 $(x, y) = (3, 2)$。

---

### 总结

通过上述例子，我们可以看到 CMA-ES 的工作流程：
1. 初始化搜索分布。
2. 采样生成候选解。
3. 根据目标函数值排序。
4. 更新搜索分布（均值、协方差矩阵、步长）。
5. 检查终止条件并决定是否继续迭代。

这种自适应调整搜索分布的能力使得 CMA-ES 在复杂优化问题中表现出色。